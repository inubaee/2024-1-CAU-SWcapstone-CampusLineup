<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- head 내용 생략 -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
      .search-container {
        max-width: 600px;
        margin: auto;
        margin-top: 50px;
      }

      .search-results {
        margin-top: 20px;
      }

      .search-filters {
        margin-top: 20px;
      }

      .search-results .list-group-item {
        display: flex;
        align-items: center;
      }

      .search-results .list-group-item img {
        width: 100px;
        height: auto;
        margin-right: 20px;
      }
    </style>
  </head>
  <body>
    <!-- 헤더 부분 include -->
    <div id="header-placeholder"></div>
    <script>
        $(function(){
            $("#header-placeholder").load("header.html");
        });
    </script>

    <!-- 검색창 -->
    <div class="container search-container">
      <h3 class="mb-4">대학교 및 아티스트를 찾아보세요</h3>
      <!-- 검색 입력창 -->
      <div class="input-group mb-3">
        <input
          type="text"
          class="form-control"
          placeholder="검색어를 입력하세요"
          aria-label="검색어를 입력하세요"
          aria-describedby="basic-addon2"
          id="searchKeyword"
        />
        <div class="input-group-append">
          <button class="btn btn-primary" type="button" onclick="search()">
            검색
          </button>
        </div>
      </div>

      <!-- 위치 및 날짜 필터 -->
      <div class="search-filters">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="searchLocation">지역</label>
            <select class="form-control" id="searchLocation">
              <option value="">전체</option>
              <option value="서울">서울</option>
              <option value="부산">부산</option>
              <!-- 추가적인 지역 옵션을 여기에 추가할 수 있습니다 -->
            </select>
          </div>
          <div class="form-group col-md-3">
            <label for="startDate">시작 날짜</label>
            <input type="date" class="form-control" id="startDate" />
          </div>
          <div class="form-group col-md-3">
            <label for="endDate">종료 날짜</label>
            <input type="date" class="form-control" id="endDate" />
          </div>
        </div>
      </div>
    </div>

    <!-- 검색 결과 영역 -->
    <div class="container search-results">
      <h3 class="mb-4">검색 결과</h3>
      <div id="searchResults" class="list-group">
        <!-- 검색 결과가 여기에 동적으로 추가됩니다 -->
      </div>
    </div>

    <!-- 최근 검색어 표시 영역 -->
    <div class="container recent-searches">
      <h3 class="mb-4">최근 검색어 결과</h3>
      <div id="recentSearches" class="list-group"></div>
    </div>

    <!-- 검색 스크립트 -->
    <script>
      // 최근 검색어 표시
      displayRecentSearches(); // 페이지 로드 시 바로 실행

      // 페이지 로드 시 실행
      document.addEventListener("DOMContentLoaded", function () {
        // 검색창 포커스
        document.getElementById("searchKeyword").focus();
      });

      // 검색 기능
      function search() {
        const keyword = document.getElementById("searchKeyword").value;

        // 선택한 필터 옵션 가져오기
        const location = document.getElementById("searchLocation").value;
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        // 쿼리 파라미터 조합
        let queryParams = `?keyword=${keyword}`;
        if (location) queryParams += `&location=${location}`;
        if (startDate) queryParams += `&startDate=${startDate}`;
        if (endDate) queryParams += `&endDate=${endDate}`;

        // API 요청
        fetch(`http://localhost:8080/festivals/search${queryParams}`)
          .then((response) => response.json())
          .then((data) => {
            displaySearchResults(data);
          })
          .catch((error) => {
            console.error("Error searching:", error);
          });

        // 최근 검색어 저장
        saveRecentSearch(keyword);
      }

      // 최근 검색어 표시
      function displayRecentSearches() {
        const recentSearchesContainer =
          document.getElementById("recentSearches");
        recentSearchesContainer.innerHTML = "";

        const recentSearches =
          JSON.parse(localStorage.getItem("recentSearches")) || [];

        if (recentSearches.length > 0) {
          recentSearches.forEach((search) => {
            const listItem = document.createElement("li");
            listItem.className = "list-group-item";
            listItem.textContent = search;
            listItem.addEventListener("click", function () {
              document.getElementById("searchKeyword").value = search;
              search();
            });
            recentSearchesContainer.appendChild(listItem);
          });
        } else {
          const message = document.createElement("p");
          message.textContent = "최근 검색어가 없습니다.";
          recentSearchesContainer.appendChild(message);
        }
      }

      // 최근 검색어 저장
      function saveRecentSearch(keyword) {
        if (keyword.trim() === "") return; // 빈 키워드인 경우 저장하지 않음

        let recentSearches =
          JSON.parse(localStorage.getItem("recentSearches")) || [];
        recentSearches = recentSearches.filter((search) => search !== keyword); // 중복 검색어 제거
        recentSearches.unshift(keyword); // 최근 검색어 맨 앞에 추가
        recentSearches = recentSearches.slice(0, 5); // 최근 검색어를 최대 5개까지 유지
        localStorage.setItem("recentSearches", JSON.stringify(recentSearches));
        displayRecentSearches(); // 변경된 최근 검색어를 화면에 표시
      }

      // 검색 결과 표시
      function displaySearchResults(results) {
        const searchResultsContainer = document.getElementById("searchResults");
        searchResultsContainer.innerHTML = "";

        results.forEach((result) => {
          const listItem = document.createElement("a");
          listItem.className = "list-group-item list-group-item-action";
          listItem.href = `festival.html?id=${result.id}`;
          listItem.innerHTML = `
            <img src="${result.imageUrl}" alt="${result.schoolName} 축제">
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1">${result.schoolName}</h5>
              <small>${result.startDate} ~ ${result.endDate}</small>
            </div>
          `;
          searchResultsContainer.appendChild(listItem);
        });
      }
    </script>
  </body>
</html>
